package com.shoppingmall.controller;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Scanner;

import com.shoppingmall.models.CartItem;
import com.shoppingmall.models.Customer;
import com.shoppingmall.models.Item;
import com.shoppingmall.models.Order;
import com.shoppingmall.service.ManagerService;
import com.shoppingmall.service.UserService;

public class MainController_KGE {
    private Scanner scanner;
    private ManagerService managerService;
    private UserService userService;

    public MainController_KGE() {
        this.scanner = new Scanner(System.in);
        managerService = new ManagerService("Java Shopping Mall");
        userService = new UserService("Java Shopping Mall");
    }

    // 1. ê´€ë¦¬ì ëª¨ë“œ ì£¼ë¬¸ê´€ë¦¬
    public void adminOrderManageMenu() {
        while (true) {
            System.out.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
            System.out.println("â”‚   ğŸ“¦[ê´€ë¦¬ì ëª¨ë“œ] ì£¼ë¬¸ ê´€ë¦¬             â”‚");
            System.out.println("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
            System.out.println("â”‚  1. ì£¼ë¬¸ ë‚´ì—­ í™•ì¸                    â”‚");
            System.out.println("â”‚  2. ì£¼ë¬¸ confirm                    â”‚");
            System.out.println("â”‚  3. ì£¼ë¬¸ ì·¨ì†Œ                        â”‚");
            System.out.println("â”‚  0. ëŒì•„ê°€ê¸°                         â”‚");
            System.out.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
            System.out.print("ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”: _");
            String menu = scanner.nextLine();
            switch(menu) {
                case "1":
                    managerService.showAllOrders();
                    break;
                case "2":
                    System.out.print("í™•ì •í•  ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ");
                    String confirmOrderId = scanner.nextLine().trim();
                    try {
                        Order order = (Order)managerService.getOrders().get(confirmOrderId);
                        managerService.confirmOrder(order != null ? order.getStatus() : null, confirmOrderId);
                        System.out.println("ì£¼ë¬¸ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } catch(Exception e) {
                        System.err.println("í™•ì • ì‹¤íŒ¨: " + e.getMessage());
                    }
                    break;
                case "3":
                    System.out.print("ì·¨ì†Œí•  ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ");
                    String cancelOrderId = scanner.nextLine().trim();
                    try {
                        Order order = (Order)managerService.getOrders().get(cancelOrderId);
                        managerService.cancelOrder(order != null ? order.getStatus() : null, cancelOrderId);
                        System.out.println("ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } catch(Exception e) {
                        System.err.println("ì·¨ì†Œ ì‹¤íŒ¨: " + e.getMessage());
                    }
                    break;
                case "0":
                    return;
                default:
                    System.out.println("ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
            System.out.println();
        }
    }

    // 2. ì‚¬ìš©ì ì¥ë°”êµ¬ë‹ˆ ê´€ë¦¬
    public void cartManageMenu(String userId) {
        while(true) {
            System.out.println("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
            System.out.println("â”‚         ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ê´€ë¦¬               â”‚");
            System.out.println("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
            System.out.println("â”‚  1. ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ                      â”‚");
            System.out.println("â”‚  2. ìƒí’ˆ ì¶”ê°€                        â”‚");
            System.out.println("â”‚  3. ìˆ˜ëŸ‰ ë³€ê²½                        â”‚");
            System.out.println("â”‚  4. ìƒí’ˆ ì‚­ì œ                        â”‚");
            System.out.println("â”‚  5. ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°                    â”‚");
            System.out.println("â”‚  0. ëŒì•„ê°€ê¸°                         â”‚");
            System.out.println("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
            System.out.print("ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”: _");
            String menu = scanner.nextLine();
            ArrayList<CartItem> cartItems = userService.getCarts().get(userId);
            switch(menu) {
                case "1":
                    if(cartItems == null || cartItems.isEmpty()) {
                        System.out.println("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
                    } else {
                        System.out.println("[ì¥ë°”êµ¬ë‹ˆ í˜„ì¬ ëª©ë¡]");
                        for(CartItem ci : cartItems) {
                            System.out.println(ci);
                        }
                    }
                    break;
                case "2":
                    System.out.print("ì¶”ê°€í•  ìƒí’ˆì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”: _");
                    String pName = scanner.nextLine();
                    Item item = userService.getItembyName(pName);
                    if(item == null) {
                        System.out.println("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìƒí’ˆì…ë‹ˆë‹¤.");
                        break;
                    }
                    System.out.print("ì¶”ê°€ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”: ");
                    try {
                        int qty = Integer.parseInt(scanner.nextLine());
                        userService.getCarts().putIfAbsent(userId, new ArrayList<CartItem>());
                        userService.getCarts().get(userId).add(new CartItem(item, qty));
                        System.out.println("ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } catch(Exception e) {
                        System.out.println("ì¶”ê°€ ì‹¤íŒ¨: " + e.getMessage());
                    }
                    break;
                case "3":
                    System.out.print("ìˆ˜ëŸ‰ì„ ë³€ê²½í•  ìƒí’ˆ ì´ë¦„: ");
                    String targetName = scanner.nextLine();
                    boolean found = false;
                    if(cartItems != null) {
                        for(CartItem ci : cartItems) {
                            if(ci.getItem().getName().equals(targetName)) {
                                System.out.print("ìƒˆ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”: ");
                                try {
                                    int newQty = Integer.parseInt(scanner.nextLine());
                                    if(newQty <= 0) {
                                        System.out.println("ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                                        break;
                                    }
                                    cartItems.remove(ci);
                                    cartItems.add(new CartItem(ci.getItem(), newQty));
                                    System.out.println("ìˆ˜ëŸ‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                    found = true;
                                    break;
                                } catch(Exception e) {
                                    System.out.println("ë³€ê²½ ì‹¤íŒ¨: " + e.getMessage());
                                }
                            }
                        }
                    }
                    if(!found) System.out.println("ì¥ë°”êµ¬ë‹ˆì— í•´ë‹¹ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
                    break;
                case "4":
                    System.out.print("ì‚­ì œí•  ìƒí’ˆì˜ ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”: _");
                    String delName = scanner.nextLine();
                    boolean removed = false;
                    if(cartItems != null)
                        removed = cartItems.removeIf(ci -> ci.getItem().getName().equals(delName));
                    if(removed) {
                        System.out.println("ì¥ë°”êµ¬ë‹ˆì—ì„œ ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        System.out.println("ì¥ë°”êµ¬ë‹ˆì— í•´ë‹¹ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    break;
                case "5":
                    if(cartItems != null) cartItems.clear();
                    System.out.println("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.");
                    break;
                case "0":
                    return;
                default:
                    System.out.println("ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
            System.out.println();
        }
    }

    // 3. ì‚¬ìš©ì ì£¼ë¬¸í•˜ê¸°
    public void placeOrderMenu(Customer customer) {
        try {
            userService.placeOrder(customer, customer.getAddress());
            System.out.println("ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(Exception e) {
            System.err.println("ì£¼ë¬¸ ì‹¤íŒ¨: " + e.getMessage());
        }
        System.out.println();
    }

    // 4. ì‚¬ìš©ì ì£¼ë¬¸ë‚´ì—­ ì¡°íšŒ
    public void showUserOrdersMenu(Customer customer) {
        HashMap<String, Order> orders = userService.getOrders();
        System.out.println("=== ì£¼ë¬¸ ë‚´ì—­ ===");
        boolean hasOrder = false;
        for(Order order : orders.values()) {
            if(order.getCustomer().getId().equals(customer.getId())) {
                System.out.println(order.getOrderDetail());
                hasOrder = true;
            }
        }
        if(!hasOrder) System.out.println("ì£¼ë¬¸ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
        System.out.println();
    }
}
